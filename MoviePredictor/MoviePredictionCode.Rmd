---
title: "Movie Recommender"
author: "H.Gryk"
date: "2020-09-15"
categories: 
  -Shiny
  -Recommender
tags:
  -Movie Recommender
  -Shiny App
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r echo=FALSE}
library(utils)
library(recommenderlab)
library(ggplot2)
library(data.table)
library(reshape2)
```

I was recently inspired to create a movie recommender when a family member started hosting a virtual movie night.  Given the variety of movie preferences of the invited group, I was motivated to create recommendations based on multiple genres and movies. 

The data used for this task is from [movielens](https://grouplens.org/datasets/movielens/).  The data available from movielens includes links, movies, ratings, and tags, however, only some of this data will be utilized herin.  

```{r echo=FALSE}
fileLoc <-"/Users/Hailey/Documents/GitHub/projects/MoviePredictor/ml-25m.zip"

#unzip(fileLoc)
movies <- read.csv("ml-25m/movies.csv")
ratings <- read.csv( "ml-25m/ratings.csv")
# tags <- read.csv("ml-25m/tags.csv")
mv_tags <- read.csv("ml-25m/genome-scores.csv")
mv_tags_desc <- read.csv("ml-25m/genome-tags.csv")
```



```{r}
# preprocessing data

genres <- as.data.frame(movies$genres, stringsAsFactors = FALSE)
genres2 <- as.data.frame(tstrsplit( genres[,1], '[|]',
                                    type.convert=TRUE),
                                    stringsAsFactors=FALSE)

colnames(genres2) <- c(1:10)
genre_list <- c("Action", "Adventure", "Animation", "Children", 
                "Comedy", "Crime","Documentary", "Drama", "Fantasy",
                "Film-Noir", "Horror", "Musical", "Mystery","Romance",
                "Sci-Fi", "Thriller", "War", "Western") #list of all the genres

genre_matrix <-matrix(0, nrow(movies)+1, length(genre_list)) #empty matrix, no movies + 1, no genres
genre_matrix[1,] <- genre_list # populate genres in first row
colnames(genre_matrix) <- genre_list # set column names with genre list

#iterate through matrix
for (i in 1:nrow(genres2)) {
  for (c in 1:ncol(genres2)) {
    genmat_col = which(genre_matrix[1,] == genres2[i,c])
    genre_matrix[i+1,genmat_col] <- 1
  }
}

#convert into dataframe
genre_matrix2 <- as.data.frame(genre_matrix[-1,], stringsAsFactors=FALSE) #remove first row, which was the genre list
for (c in 1:ncol(genre_matrix2)) {
  genre_matrix2[,c] <- as.integer(genre_matrix2[,c])
} #convert from characters to integers


```

```{r}
#Create a matrix to search for a movie by genre:
years <- as.data.frame(movies$title, stringsAsFactors=FALSE)
library(data.table)
substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}
years <- as.data.frame(substr(substrRight(substrRight(years$`movies$title`, 6),5),1,4))

search_matrix <- cbind(movies[,1], substr(movies[,2],1,nchar(movies[,2])-6), years, genre_matrix2)
colnames(search_matrix) <- c("movieId", "title", "year", genre_list)

write.csv(search_matrix, "search.csv")
search_matrix <- read.csv("search.csv", stringsAsFactors=FALSE)

# at this point we can search for movies with the following:
#subset(search_matrix, Crime ==1 & year == 2019)$title
```

```{r}
# ratings are on a larger scale than the tag comparison result will be so scale the ratings.  
scaleratings <- ratings[,1:3]
scaleratings$rating <- scaleratings$rating / 10


```

```{r}
scaleratings2 <- dcast(scaleratings[1:100000,], movieId~userId, value.var = "rating", na.rm=FALSE)

for (i in 1:ncol(scaleratings2)){
  scaleratings2[which(is.na(scaleratings2[,i]) == TRUE),i] <- 0
}
scaleratings2 = scaleratings2[,-1] #remove movieIds col. Rows are movieIds, cols are userIds

```



